#! /bin/bash
#
# gfarm-pgsql	Start the PostgreSQL daemon - postmaster.
#

PATH=/sbin:/bin:/usr/sbin:/usr/bin

FILE="gfarm-pgsql"

PGPORT="@config_gfarm_backend_port@"
PGDATA="@config_gfarm_backend_data_dir@"
CTL="@config_gfarm_pgsql_bindir@/pg_ctl"
PIDFILE="$PGDATA/portmaster.pid"
OPTIONS="@config_gfarm_pgsql_options@"
PRIVILEGE="@config_gfarm_backend_privilege@"
# For SELinux we need to use 'runuser' not 'su'
[ -x /sbin/runuser ] && SU=/sbin/runuser || SU=su
case $PRIVILEGE in
'')	RUN=/bin/sh;;
*)	RUN="$SU - $PRIVILEGE";;
esac

trap "" 1
export LANG=C
export PATH
export PGPORT
export PGDATA

test -f $CTL || exit 0
test -d $PGDATA || exit 0

call_pg_ctl()
{
	$RUN -c "$CTL $OPTIONS $*"
}

checkstatus()
{
	call_pg_ctl status
	RETVAL=$?
	[ $RETVAL -eq 1 ] && RETVAL=3
	return $RETVAL
}

wait_to_start()
{
	iter=0
	# XXX - checkstatus cannot ensure the database really starts up
	while if checkstatus; then false; else true; fi >/dev/null 2>&1
	do
		iter=`expr $iter + 1`
		[ $iter -gt 6 ] && exit 1
		sleep 5
	done
}

RETVAL=0

case "$1" in
  start)
	echo -n "Starting gfarm server: $FILE"
	checkstatus > /dev/null
	RETVAL=$?
	if [ $RETVAL -ne 0 ]; then
		call_pg_ctl start
		RETVAL=$?
	fi
	wait_to_start
	echo "."
	;;
  stop)
	echo -n "Stopping gfarm server: $FILE"
	checkstatus > /dev/null
	RETVAL=$?
	if [ $RETVAL -eq 3 ]; then
		RETVAL=0
	else
		call_pg_ctl stop > /dev/null
		RETVAL=$?
	fi
	echo "."
	;;
  status)
	checkstatus
	RETVAL=$?
	;;
  restart)
	call_pg_ctl restart > /dev/null
	RETVAL=$?
	;;
  force-reload)
	call_pg_ctl reload
	RETVAL=$?
	;;
  *)
	echo "Usage: /etc/init.d/$FILE {start|stop|restart}"
	exit 1
	;;
esac

exit $RETVAL
