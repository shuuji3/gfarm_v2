#!/bin/sh

TMP=/tmp/$0-$$

case $1 in
-s)
	shift
	SPOOL=$1
	shift
esac

: ${SPOOL:="/var/gfarm-spool"}

for i
do
	gfstat $i > $TMP || continue
	inum=`sed -n 's/.*Inode: \([0-9]*\).*/\1/p' $TMP`
	gen=`sed -n 's/.*Gen: \([0-9]*\).*/\1/p' $TMP`
	size=`sed -n 's/.*Size: \([0-9]*\).*/\1/p' $TMP`
	path=`printf "%016X%016X" $inum $gen |
		sed 's/\([0-9A-F]\{8\}\)\([0-9A-F][0-9A-F]\)\([0-9A-F][0-9A-F]\)\([0-9A-F][0-9A-F]\)\([0-9A-F]\{18\}\)/\1\/\2\/\3\/\4\/\5/'`
	path="data/$path"
	echo $path
	if [ -f "$SPOOL/$path" ]; then
		rsize=`stat --printf="%s" "$SPOOL/$path"`
		[ $size != $rsize ] &&
			echo "$i: size mismatch (meta $size real $rsize)"
	fi
done

rm -f $TMP
