.\" This manpage has been automatically generated by docbook2man 
.\" from a DocBook document.  This tool can be found at:
.\" <http://shell.ipoline.com/~elmert/comp/docbook2X/> 
.\" Please send any bug reports, improvements, comments, patches, 
.\" etc. to Steve Cheng <steve@ggi-project.org>.
.TH "GFSERVICE" "1" "07 June 2013" "Gfarm" ""

.SH NAME
gfservice \- control Gfarm servers from a remote host
.SH SYNOPSIS

\fBgfservice\fR [ \fB\fIoptions\fB\fR ] \fBsub-command\fR [ \fBhost-id\fR ] [ \fB\fIargument ...\fB\fR ]

.SH "DESCRIPTION"
.PP
\fBgfservice\fR is an utility for Gfarm administrators
to operate servers (\fBgfmd\fR, \fBgfsd\fR and
PostgreSQL) on remote hosts.
OpenLDAP is not supported currently.
It can start, stop, set up (execute \fBconfig-gfarm\fR
and \fBconfig-gfsd\fR) and clean up the servers, for example.
.PP
A sample command line of \fBgfservice\fR looks like:

.nf
	\fBgfservice \fIstart-gfmd\fB \fIgfmd2\fB\fR
.fi
.PP
where "\fIstart-gfmd\fR" is a sub-command and
\fIgfmd2\fR is a host-id respectively.
Executing the command, \fBgfservice\fR tries to start gfmd
on the host named \fIgfmd2\fR\&.
To specify a remote server host, \fBgfservice\fR uses
host-id instead of hostname.
All host-ids (\fIgfmd1\fR,
\fIgfmd2\fR, and so on) are defined in a configuration
file of \fBgfservice\fR\&.
Here is an example of the configuration file:

.nf
	gfmd1=metadb1.example.com
	gfmd1_CONFIG_GFARM_OPTIONS="-A $LOGNAME -X"
	gfmd2=metadb2.example.com
	gfmd2_CONFIG_GFARM_OPTIONS="-A $LOGNAME -X"

	gfsd1=spool1.example.com
	gfsd2=spool2.example.com
.fi
.PP
\fBgfservice\fR determines a path of the configuration
file to be read with the following procedures:
.TP 3
1. 
\fB-f\fR \fIfile\fR option is specified, read
\fIfile\fR\&.
.TP 3
2. 
Otherwise, the environment variable
GFSERVICE_CONF is defined and not empty, read the file.
.TP 3
3. 
Otherwise, read \fI$HOME/.gfservice\fR\&.
.PP
If \fBgfservice\fR fails to read a configuration file,
it prints an error message and exits immediately.
Note that the configuration file itself is a Bourne-shell script and
\fBgfservice\fR includes (exactly to say, 
\fBevaluates\fR) the file.
See gfservice.conf(5) for more details about the configuration file.
.PP
\fBgfservice\fR uses SSH (Secure Shell) to connect with
a remote host.
Since it may execute \fBssh\fR several times during a
sub-command operation, it is recommended to use an SSH agent
(e.g. \fBssh-agent\fR of OpenSSH) or an authentication key
with an empty passphrase to avoid typing a passphrase every time.
.PP
In addition with SSH, \fBgfservice\fR uses Sudo to get
root privilege on the remote host.
Please add a line like below to \fIsudoers\fR file
(Sudo's configuration file) on each remote host.

.nf
	\fIuser\fR ALL=(root, _gfarmfs, _gfarmmd) NOPASSWD: gfservice-agent
.fi
.PP
where \fIuser\fR is an user name who executes
\fBgfservice\fR\&.
The NOPASSWD option is not mandatory, but \fBsudo\fR may
ask you a password several times if omitted.
.PP
Since \fBgfservice\fR executes an agent command named
\fBgfservice-agent\fR on the remote host using SSH and Sudo,
\fBgfservice-agent\fR command must have been installed on
all hosts you want to operate using \fBgfservice\fR\&.
.PP
\fBgfservice\fR has a plug-in system so that user can add
new sub-commands. See "PLUG-IN SYSTEM" section of this man page for
more details.
.SH "OPTIONS"
.TP
\fB-d\fR
Print debug information.
\fBgfservice\fR passes this option to
\fBgfservice-agent\fR so that also
\fBgfservice-agent\fR outputs debug information.
.TP
\fB-f \fIfile\fB\fR
Read configuration from \fIfile\fR instead of the default.
.TP
\fB-t \fItime\fB\fR
Set operation timeout in \fItime\fR seconds.
When \fBgfservice\fR tries to start or stop a server program
(gfmd, gfsd or a backend database), it waits until the operation is complete
or \fItime\fR interval is elapsed.
If "no" is specified as \fItime\fR, timeout never occurs.
The default value is "no".
.TP
\fB-k\fR
When this option is specified with sub-command
\fBconfig-gfarm\fR or
\fBconfig-gfarm-master\fR, \fBgfservice\fR
creates a shared secret key files using \fBgfkey\fR
command.
.SH "SUB-COMMANDS FOR GFMD"
.PP
The followings are sub-commands which operate \fBgfmd\fR\&.
The given host-id argument must be "gfmd\fIn\fR"
(gfmd1, gfmd2, ...).
Otherwise \fBgfservice\fR reports an error and exits
immediately.
.TP
\fBbackend-db-status \fIhost-id\fB\fR
Exit with an exit code 0, if a backend database is currently running.
Otherwise exits with 1.
.TP
\fBgfmd-status \fIhost-id\fB\fR
Exit with an exit code 0, if \fBgfmd\fR is currently running.
Otherwise exits with 1.
.TP
\fBstart-backend-db \fIhost-id\fB\fR
Start a backend database if it is not running currently.
.TP
\fBstart-gfmd \fIhost-id\fB\fR
Start \fBgfmd\fR if it is not running currently.
.TP
\fBstart-gfmd-master \fIhost-id\fB\fR
An alias of "\fBstart-gfmd\fR" sub-command.
.TP
\fBstart-gfmd-slave \fIhost-id\fB\fR
This sub-command is the same as "\fBstart-gfmd\fR",
but \fB-S\fR option is added to \fBgfmd\fR\&.
.TP
\fBstart-gfarm \fIhost-id\fB\fR
Start a backend database and \fBgfmd\fR if they are
not running currently.
.TP
\fBstart-gfarm-master \fIhost-id\fB\fR
An alias of "\fBstart-gfarm\fR" sub-command.
.TP
\fBstart-gfarm-slave \fIhost-id\fB\fR
This sub-command is the same as "\fBstart-gfarm\fR",
but \fB-S\fR option is added to \fBgfmd\fR\&.
.TP
\fBstop-backend-db \fIhost-id\fB\fR
Stop a backend database if it is running currently.
.TP
\fBstop-gfmd \fIhost-id\fB\fR
Stop \fBgfmd\fR if it is running currently.
.TP
\fBstop-gfarm \fIhost-id\fB\fR
Stop \fBgfmd\fR and a backend database if they are running
currently.
.TP
\fBkill-gfmd \fIhost-id\fB\fR
Kill \fBgfmd\fR (send SIGKILL) if it is running currently.
.TP
\fBrestart-backend-db \fIhost-id\fB\fR
Perform "\fBstop-backend-db\fR" and 
"\fBstart-backend-db\fR" sub-commands successively.
.TP
\fBrestart-gfmd \fIhost-id\fB\fR
Perform "\fBstop-gfmd\fR" and
"\fBstart-gfmd\fR" sub-commands successively.
.TP
\fBrestart-gfmd-master \fIhost-id\fB\fR
An alias of "\fBrestart-gfmd\fR" sub-command.
.TP
\fBrestart-gfmd-slave \fIhost-id\fB\fR
Perform "\fBstop-gfmd\fR" and 
"\fBstart-gfmd-slave\fR" sub-commands successively.
.TP
\fBrestart-gfarm \fIhost-id\fB\fR
Perform "\fBstop-gfarm\fR" and 
"\fBstart-gfarm\fR" sub-commands successively.
.TP
\fBrestart-gfarm-master \fIhost-id\fB\fR
An alias of "\fBrestart-gfarm\fR" sub-command.
.TP
\fBrestart-gfarm-slave \fIhost-id\fB\fR
Perform "\fBstop-gfarm\fR" and 
"\fBstart-gfarm-slave\fR" sub-commands successively.
.TP
\fBpromote \fIhost-id\fB\fR
Promote \fBgfmd\fR from a slave to a master.
.TP
\fBpromote-gfmd \fIhost-id\fB\fR
An alias of "\fBpromote\fR" sub-command.
.TP
\fBset-gfmd-conf \fIhost-id\fB \fIdirective\fB \fIvalue\fB\fR
Add

.nf
	\fIdirective\fR \fIvalue\fR
.fi

line to \fIgfmd.conf\fR file on the remote host.
If \fIgfmd.conf\fR already has a
\fIdirective\fR line, \fBgfservice\fR
deletes it and then add a new line.
.TP
\fBset-gfsd-conf \fIhost-id\fB \fIdirective\fB \fIvalue\fB\fR
Add

.nf
	\fIdirective\fR \fIvalue\fR
.fi

line to \fIgfsd.conf\fR file on the remote host.
If \fIgfsd.conf\fR already has a
\fIdirective\fR line, \fBgfservice\fR
deletes it and then add a new line.
.TP
\fBunset-gfmd-conf \fIhost-id\fB \fIdirective\fB\fR
Delete a \fIdirective\fR line in
\fIgfmd.conf\fR file on the remote host.
If \fIgfmd.conf\fR file doesn't contain
\fIdirective\fR line, the file is unchanged.
.TP
\fBunset-gfsd-conf \fIhost-id\fB \fIdirective\fB\fR
Delete a \fIdirective\fR line in
\fIgfsd.conf\fR file on the remote host.
If \fIgfsd.conf\fR file doesn't contain
\fIdirective\fR line, the file is unchanged.
.TP
\fBbackup-backend-db\fR
Backup a backend database on the remote host and output the backup data
to standard out.
.TP
\fBbackup-gfmd-conf \fIhost-id\fB\fR
Output \fIgfmd.conf\fR file on the remote host to
standard out.
.TP
\fBbackup-gfsd-conf \fIhost-id\fB\fR
Output \fIgfsd.conf\fR file on the remote host to
standard out.
This sub-command can be worked only when the remote host is configured
in the private mode.
.TP
\fBbackup-usermap \fIhost-id\fB\fR
Output \fIusermap\fR file on the remote host to
standard out.
This sub-command can be worked only when the remote host is configured
in the private mode.
.TP
\fBrestore-backend-db \fIhost-id\fB\fR
Restore a backend database on the remote host.
The backup data are read from standard in.
.TP
\fBrestore-gfmd-conf \fIhost-id\fB\fR
Recover \fIgfmd.conf\fR file on the remote host.
\fBgfservice\fR reads a backup of \fIgfmd.conf\fR
from standard in.
.TP
\fBrestore-gfsd-conf \fIhost-id\fB\fR
Recover \fIgfsd.conf\fR file on the remote host.
\fBgfservice\fR reads a backup of \fIgfsd.conf\fR
from standard in.
This sub-command can be worked only when the remote host is configured
in the private mode.
.TP
\fBrestore-usermap \fIhost-id\fB\fR
Recover \fIusermap\fR file on the remote host.
\fBgfservice\fR reads a backup of \fIusermap\fR
from standard in.
This sub-command can be worked only when the remote host is configured
in the private mode.
.TP
\fBconfig-gfarm \fIhost-id\fB\fR
Execute \fBconfig-gfarm\fR command on the remote host.
If "gfmd\fIn\fR_CONFIG_GFARM_OPTIONS" variable is
declared in the configuration file of \fBgfservice\fR,
its value is passed to \fBconfig-gfarm\fR command as
options.
Don't use this sub-command when you want to enable replication of gfmd.
Instead, use "\fBconfig-gfarm-master\fR" or
"\fBconfig-gfarm-slave\fR" sub-command in that case.
If \fB-k\fR option is specified, \fBgfservice\fR
also creates a shared secret key files onto the gfmd host, using
\fBgfkey\fR command.
.TP
\fBconfig-gfarm-master \fIhost-id\fB\fR
This sub-command is the same as \fBconfig-gfarm\fR
but gfmd replication is enabled automatically.
.TP
\fBconfig-gfarm-slave \fIhost-id\fB \fImaster-host-id\fB\fR
This sub-command is the same as \fBconfig-gfarm\fR
but gfmd replication is enabled automatically and the remote gfmd host
is configured as a slave of \fImaster-host-id\fR\&.
Then \fBgfservice\fR registers the slave host to a server list
using \fBgfmdhost\fR command.
\fBgfservice\fR also adds the slave host to
metadb_server_list directive in
\fIgfarm2.conf\fR file on the master gfmd host and
distribute the updated \fIgfarm2.conf\fR file to all hosts
defined in the configuration file.
It also updates \fIgfsd.conf\fR file and distributes it to
all gfmd and gfsd hosts, if "gfmd\fIn\fR_PRIVATE_MODE"
variable is set to "true".
If the value of the variable "gfmd\fIn\fR_AUTH_TYPE"
is "sharedsecret", it also copies a shared key file from the maste gfmd
to the slave gfmd host.
.TP
\fBunconfig-gfarm \fIhost-id\fB\fR
Execute "\fBstop-gfarm\fR" sub-command and then delete all
files and directories created by gfmd and a backend database.
If you want to unconfigure a slave gfmd, use
"\fBunconfig-gfarm-slave\fR" sub-command instead.
.TP
\fBunconfig-gfarm-master \fIhost-id\fB\fR
An alias of "\fBunconfig-gfarm\fR" sub-command.
.TP
\fBunconfig-gfarm-slave \fIhost-id\fB \fImaster-host-id\fB\fR
This sub-command is the same as "\fBunconfig-gfarm\fR",
but \fBgfservice\fR does some additional works.
It also deletes the slave host from a server list using
\fBgfmdhost\fR command and from
metadb_server_list directive in
\fIgfarm2.conf\fR file on all hosts defined in the
configuration file.
It also updates \fIgfsd.conf\fR file and distributes it to
all gfmd and gfsd hosts, if "gfmd\fIn\fR_PRIVATE_MODE"
variable is set to "true".
.SH "SUB-COMMANDS FOR GFSD"
.PP
The followings are sub-commands which operate \fBgfsd\fR\&.
The given host-id argument must be "gfsd\fIn\fR"
(gfsd1, gfsd2, ...).
Otherwise \fBgfservice\fR reports an error and exits
immediately.
.TP
\fBgfsd-status \fIhost-id\fB\fR
Exit with an exit code 0, if \fBgfsd\fR is currently running.
Otherwise exits with 1.
.TP
\fBstart-gfsd\fR
Start \fBgfsd\fR if it is not running currently.
.TP
\fBstop-gfsd\fR
Stop \fBgfsd\fR if it is running currently.
.TP
\fBrestart-gfsd \fIhost-id\fB\fR
Perform "\fBstop-gfsd\fR" and "\fBstart-gfsd\fR"
sub-commands successively.
.TP
\fBset-gfsd-conf \fIhost-id\fB \fIdirective\fB \fIvalue\fB\fR
Same as \fBset-gfsd-conf\fR sub-command for gfmd.
.TP
\fBunset-gfsd-conf \fIhost-id\fB \fIdirective\fB\fR
Same as \fBunset-gfsd-conf\fR sub-command for gfmd.
.TP
\fBbackup-gfsd-conf \fIhost-id\fB\fR
Same as \fBbackup-gfsd-conf\fR sub-command for gfmd.
.TP
\fBbackup-usermap \fIhost-id\fB\fR
Same as \fBbackup-usermap\fR sub-command for gfmd.
.TP
\fBrestore-gfsd-conf \fIhost-id\fB\fR
Same as \fBrestore-gfsd-conf\fR sub-command for gfmd.
.TP
\fBrestore-usermap \fIhost-id\fB\fR
Same as \fBrestore-usermap\fR sub-command for gfmd.
.TP
\fBconfig-gfsd \fIhost-id\fB\fR
Execute "\fBconfig-gfsd\fR" command on the remote host.
If "gfsd\fIn\fR_CONFIG_GFSD_OPTIONS" variable is
declared in the configuration file of \fBgfservice\fR,
its value is passed to \fBconfig-gfsd\fR command as
options.
\fBgfservice\fR also registers the configured remote host
as a filesystem node using \fBgfhost\fR command.
If the value of the variable "gfsd\fIn\fR_AUTH_TYPE"
is "sharedsecret", it also copies a shared key file from gfmd1 to the
gfsd host.
.TP
\fBunconfig-gfsd \fIhost-id\fB\fR
Execute "\fBstop-gfsd\fR" sub-command and then delete all
files and directories created by gfsd.
.SH "SUB-COMMANDS FOR CLIENT"
.PP
The followings are sub-commands which operate a client.
The given host-id argument must be "gfmd\fIn\fR"
(gfmd1, gfmd2, ...), "gfsd\fIn\fR" (gfsd1, gfsd2, ...)
or "client\fIn\fR" (client1, client2, ...).
Otherwise \fBgfservice\fR reports an error and exits
immediately.
.TP
\fBmount \fIhost-id\fB \fIdirectory\fB \fIoption...\fB\fR
Mount a Gfarm2 filesystem on \fIdirectory\fR on the
remote host.
The argument \fIoption\fR is an option to 
\fBgfarm2fs\fR command.
.TP
\fBunmount \fIhost-id\fB \fIdirectory\fB\fR
Unmount a Gfarm2 filesystem on \fIdirectory\fR on the
remote host.
.TP
\fBumount \fIhost-id\fB \fIdirectory\fB\fR
An alias of "\fBunmount\fR" sub-command.
.TP
\fBset-gfarm-conf \fIhost-id\fB \fIdirective\fB \fIvalue\fB\fR
Add

.nf
	\fIdirective\fR \fIvalue\fR
.fi

line to \fIgfarm2.conf\fR file on the remote host.
If \fIgfarm2.conf\fR already has a
\fIdirective\fR line, \fBgfservice\fR
deletes it and then add a new line.
.TP
\fBunset-gfarm-conf \fIhost-id\fB \fIdirective\fB\fR
Delete a \fIdirective\fR line in
\fIgfarm2.conf\fR file on the remote host.
If \fIgfarm2.conf\fR file doesn't contain
\fIdirective\fR line, the file is unchanged.
.TP
\fBbackup-gfarm-conf \fIhost-id\fB\fR
Output \fIgfarm2.conf\fR file on the remote host to
standard out.
.TP
\fBbackup-shared-key \fIhost-id\fB\fR
Output a shared secret key file to standard out.
.TP
\fBrestore-gfarm-conf \fIhost-id\fB\fR
Recover \fIgfarm2.conf\fR file on the remote host.
\fBgfservice\fR reads a backup of \fIgfarm2.conf\fR
from standard in.
.TP
\fBrestore-shared-key \fIhost-id\fB\fR
Recover a shared secret key file on the remote host.
\fBgfservice\fR reads a backup of the shared secret key from
standard in.
.TP
\fBconfig-client \fIhost-id\fB\fR
Copy \fIgfarm2.conf\fR file from gfmd1 to the client
host.
If the value of the variable "client\fIn\fR_AUTH_TYPE"
is "sharedsecret", it also copies a shared key file from gfmd1 to the
client host.
.TP
\fBunconfig-client \fIhost-id\fB\fR
Delete \fIgfarm2.conf\fR file and a shared secret key file
on the remote host.
.TP
\fBgfcmd \fIhost-id\fB \fIcommand-name\fB \fIcommand-argument ...\fB\fR
Execute a Gfarm command on the remote host.
.SH "SUB-COMMANDS FOR MULTIPLE HOSTS"
.PP
The followings are sub-commands which operate on multiple hosts.
The host-id argument must not be specified.
.TP
\fBstart-all\fR
Start all backend databases, \fBgfmd\fR servers and 
\fBgfsd\fR servers.
.TP
\fBstop-all\fR
Stop all \fBgfsd\fR servers, \fBgfmd\fR servers
and backend databases,
.TP
\fBrestart-all\fR
Perform "\fBstop-all\fR" and
"\fBstart-all\fR" sub-commands successively.
.TP
\fBconfig-all\fR
Perform "\fBconfig-gfarm-master\fR" for
\fIgfmd1\fR and "\fBconfig-gfarm-slave\fR"
for all other gfmd nodes.
Then, perform "\fBconfig-gfsd\fR" for all gfds nodes.
Finally, perform "\fBconfig-client\fR" for all client nodes.
.TP
\fBunconfig-all\fR
Perform "\fBunconfig-client\fR" for all client nodes.
Then, perform "\fBunconfig-gfsd\fR" for all gfds nodes.
Finally, perform "\fBunconfig-gfarm\fR" for all gfmd nodes.
.SH "PLUG-IN SYSTEM"
.PP
\fBgfservice\fR has a plug-in system so that user can add
new sub-commands. If given sub-command is not provided by
\fBgfservice\fR, \fBgfservice\fR refers to
a file which has name of sub-command under %%DATADIR%%/gfarm/gfservice
directory.
.PP
Sub-command file must be written as Bourne shell script. Sub-command
file for sub-command "\fIname\fR", must have
shell function named
"\fBsubcmd_\fIname\fB\fR" which
will be executed from \fBgfservice\fR, and
"\fBsubcmd_\fIname\fB_agent\fR"
which will be executed from \fBgfservice-agent\fR\&.
.PP
For the case a sub-command depends on a other user provided
sub-command, Sub-command file for sub-command
"\fIname\fR", must have shell function named
"\fB\fIname\fB_depends\fR" which
must return list of sub-commands. List of sub-commands must be a
string which is space separated list of sub-command names. If
sub-command or it's agent does not have dependencies, return empty
string.  Similarly, sub-command file must have shell function named
"\fB\fIname\fB_agent_depends\fR"
which must return list of sub-command's agents.
