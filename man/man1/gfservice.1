.\" This manpage has been automatically generated by docbook2man 
.\" from a DocBook document.  This tool can be found at:
.\" <http://shell.ipoline.com/~elmert/comp/docbook2X/> 
.\" Please send any bug reports, improvements, comments, patches, 
.\" etc. to Steve Cheng <steve@ggi-project.org>.
.TH "GFSERVICE" "1" "16 April 2013" "Gfarm" ""

.SH NAME
gfservice \- control Gfarm servers from a remote host
.SH SYNOPSIS

\fBgfservice\fR [ \fB\fIoptions\fB\fR ] \fBsub-command\fR [ \fBhost-id\fR ] [ \fB\fIargument ...\fB\fR ]

.SH "DESCRIPTION"
.PP
\fBgfservice\fR is an utility for Gfarm administrators
to operate servers (\fBgfmd\fR, \fBgfsd\fR and
PostgreSQL) on remote hosts.
OpenLDAP is not supported currently.
It can start, stop, set up (execute \fBconfig-gfarm\fR
and \fBconfig-gfsd\fR) and clean up the servers, for example.
.PP
A sample command line of \fBgfservice\fR looks like:

.nf
	\fBgfservice \fIstart-gfmd\fB \fIgfmd2\fB\fR
.fi
.PP
where "\fIstart-gfmd\fR" is a sub-command and
\fIgfmd2\fR is a host-id respectively.
Executing the command, \fBgfservice\fR tries to start gfmd
on the host named \fIgfmd2\fR\&.
To specify a remote server host, \fBgfservice\fR uses
host-id instead of hostname.
All host-ids (\fIgfmd1\fR,
\fIgfmd2\fR, and so on) are defined in a configuration
file of \fBgfservice\fR\&.
Here is an example of the configuration file:

.nf
	gfmd1=metadb1.example.com
	gfmd1_CONFIG_GFARM_OPTIONS="-A $LOGNAME -X"
	gfmd2=metadb2.example.com
	gfmd2_CONFIG_GFARM_OPTIONS="-A $LOGNAME -X"

	gfsd1=spool1.example.com
	gfsd2=spool2.example.com
.fi
.PP
\fBgfservice\fR determines a path of the configuration
file to be read with the following procedures:
.TP 3
1. 
\fB-f\fR \fIfile\fR option is specified, read
\fIfile\fR\&.
.TP 3
2. 
Otherwise, the environment variable
GFSERVICE_CONF is defined and not empty, read the file.
.TP 3
3. 
Otherwise, read \fI$HOME/.gfservice\fR\&.
.PP
If \fBgfservice\fR fails to read a configuration file,
it prints an error message and exits immediately.
Note that the configuration file itself is a Bourne-shell script and
\fBgfservice\fR includes (exactly to say, 
\fBevaluates\fR) the file.
See gfservice.conf(5) for more details about the configuration file.
.PP
\fBgfservice\fR uses SSH (Secure Shell) to connect with
a remote host.
Since it may execute \fBssh\fR several times during a
sub-command operation, it is recommended to use an SSH agent
(e.g. \fBssh-agent\fR of OpenSSH) or an authentication key
with an empty passphrase to avoid typing a passphrase every time.
.PP
In addition with SSH, \fBgfservice\fR uses Sudo to get
root privilege on the remote host.
Please add a line like below to \fIsudoers\fR file
(Sudo's configuration file) on each remote host.

.nf
	\fIuser\fR ALL=(root, _gfarmfs, _gfarmmd) NOPASSWD: gfservice-agent
.fi
.PP
where \fIuser\fR is an user name who executes
\fBgfservice\fR\&.
The NOPASSWD option is not mandatory, but \fBsudo\fR may
ask you a password several times if omitted.
.PP
Since \fBgfservice\fR executes an agent command named
\fBgfservice-agent\fR on the remote host using SSH and Sudo,
\fBgfservice-agent\fR command must have been installed on
all hosts you want to operate using \fBgfservice\fR\&.
.PP
\fBgfservice\fR has a plug-in system so that user can add
new sub-commands. See "PLUGIN SYSTEM" section of this man page for
details about a plug-in system.
.SH "OPTIONS"
.TP
\fB-d\fR
Print debug information.
\fBgfservice\fR passes this option to
\fBgfservice-agent\fR so that also
\fBgfservice-agent\fR outputs debug information.
.TP
\fB-f \fIfile\fB\fR
Read configuration from \fIfile\fR instead of the default.
.TP
\fB-t \fItime\fB\fR
Set operation timeout in \fItime\fR seconds.
When \fBgfservice\fR tries to start or stop a server program
(gfmd, gfsd or a backend database), it waits until the operation is complete
or \fItime\fR interval is elapsed.
If "no" is specified as \fItime\fR, timeout never occurs.
The default value is "no".
.TP
\fB-k\fR
Setup shared key if authentication type is "sharedsecret".
When this option is specified with sub-command
\fBconfig-gfarm\fR or
\fBconfig-gfarm-master\fR, \fBgfservice\fR
creates a shared secret key and then distributes the key to all hosts
defined in the configuration file.
When this option is specified with sub-commands
\fBconfig-gfarm-slave\fR or
\fBconfig-gfsd\fR, \fBconfig-client\fR,
\fBgfservice\fR copies the key from gfmd host.
.SH "SUB-COMMANDS FOR GFMD"
.PP
The followings are sub-commands which operate \fBgfmd\fR\&.
The given host-id argument must be "gfmd\fIn\fR"
(gfmd1, gfmd2, ...).
Otherwise \fBgfservice\fR reports an error and exits
immediately.
.TP
\fBbackend-db-status\fR
Exit with an exit code 0, if a backend database is currently running.
Otherwise exits with 1.
.TP
\fBgfmd-status\fR
Exit with an exit code 0, if \fBgfmd\fR is currently running.
Otherwise exits with 1.
.TP
\fBstart-backend-db\fR
Start a backend database if it is not running currently.
.TP
\fBstart-gfmd\fR
Start \fBgfmd\fR if it is not running currently.
.TP
\fBstart-gfmd-master\fR
Delete metadb_server_force_slave directive in 
\fIgfmd.conf\fR on the remote host if the directive is
specified in the file.
Then start \fBgfmd\fR if it is not running currently.
Note that this sub-command doesn't ensure that \fBgfmd\fR
on the remote host runs in master mode.
.TP
\fBstart-gfmd-slave\fR
Set metadb_server_force_slave directive in 
\fIgfmd.conf\fR on the remote host to the value "enabled".
Then start \fBgfmd\fR if it is not running currently.
.TP
\fBstart-gfarm\fR
Start a backend database and \fBgfmd\fR if they are
not running currently.
.TP
\fBstart-gfarm-master\fR
Delete metadb_server_force_slave directive in 
\fIgfmd.conf\fR on the remote host if the directive is
specified in the file.
Then start a backend database and \fBgfmd\fR if they are
not running currently.
Note that this sub-command doesn't ensure that \fBgfmd\fR
on the remote host runs in a master mode.
.TP
\fBstart-gfarm-slave\fR
Set metadb_server_force_slave directive in 
\fIgfmd.conf\fR on the remote host to the value "enabled".
Then start a backend database and \fBgfmd\fR if they are
not running currently.
.TP
\fBstop-backend-db\fR
Stop a backend database if it is running currently.
.TP
\fBstop-gfmd\fR
Stop \fBgfmd\fR if it is running currently.
.TP
\fBstop-gfarm\fR
Stop \fBgfmd\fR and a backend database if they are running
currently.
.TP
\fBkill-gfmd\fR
Kill \fBgfmd\fR (send SIGKILL) if it is running currently.
.TP
\fBrestart-backend-db\fR
Perform "\fBstop-backend-db\fR" and 
"\fBstart-backend-db\fR" sub-commands successively.
.TP
\fBrestart-gfmd\fR
Perform "\fBstop-gfmd\fR" and
"\fBstart-gfmd\fR" sub-commands successively.
.TP
\fBrestart-gfmd-master\fR
Perform "\fBstop-gfmd\fR" and
"\fBstart-gfmd-master\fR" sub-commands successively.
.TP
\fBrestart-gfmd-slave\fR
Perform "\fBstop-gfmd\fR" and 
"\fBstart-gfmd-slave\fR" sub-commands successively.
.TP
\fBrestart-gfarm\fR
Perform "\fBstop-gfarm\fR" and 
"\fBstart-gfarm\fR" sub-commands successively.
.TP
\fBrestart-gfarm-master\fR
Perform "\fBstop-gfarm\fR" and 
"\fBstart-gfarm-master\fR" sub-commands successively.
.TP
\fBrestart-gfarm-slave\fR
Perform "\fBstop-gfarm\fR" and 
"\fBstart-gfarm-slave\fR" sub-commands successively.
.TP
\fBpromote\fR
Promote \fBgfmd\fR from a slave to a master.
.TP
\fBpromote-gfmd\fR
An alias of "\fBpromote\fR" sub-command.
.TP
\fBset-gfmd-conf \fIdirective\fB \fIvalue\fB\fR
Add

.nf
	\fIdirective\fR \fIvalue\fR
.fi

line to \fIgfmd.conf\fR file on the remote host.
If \fIgfmd.conf\fR already has a
\fIdirective\fR line, \fBgfservice\fR
deletes it and then add a new line.
.TP
\fBunset-gfmd-conf \fIdirective\fB\fR
Delete a \fIdirective\fR line in
\fIgfmd.conf\fR file on the remote host.
If \fIgfmd.conf\fR file doesn't contain
\fIdirective\fR line, the file is unchanged.
.TP
\fBbackup-backend-db\fR
Backup a backend database on the remote host and output the backup data
to standard out.
.TP
\fBbackup-gfmd-conf\fR
Output \fIgfmd.conf\fR file on the remote host to
standard out.
.TP
\fBrestore-backend-db\fR
Restore a backend database on the remote host.
The backup data are read from standard in.
.TP
\fBrestore-gfmd-conf\fR
Recover \fIgfmd.conf\fR file on the remote host.
\fBgfservice\fR reads a backup of \fIgfmd.conf\fR
from standard in.
.TP
\fBconfig-gfarm\fR
Execute \fBconfig-gfarm\fR command on the remote host.
If "gfmd\fIn\fR_CONFIG_GFARM_OPTIONS" variable is
declared in the configuration file of \fBgfservice\fR,
its value is passed to \fBconfig-gfarm\fR command as
options.
Don't use this sub-command when you want to enable replication of gfmd.
Instead, use "\fBconfig-gfarm-master\fR" or
"\fBconfig-gfarm-slave\fR" sub-command in that case.
\fBgfservice\fR distributes
\fIgfarm2.conf\fR file to all hosts defined in the
configuration file(gfmd\fIn\fR,
gfsd\fIn\fR and
client\fIn\fR).
If authentication type is "sharedsecret" and \fB-k\fR
option is specified, \fBgfservice\fR also creates a
shared secret key using \fBgfkey\fR command and then
distributes the key.
.TP
\fBconfig-gfarm-master\fR
This sub-command is the same as \fBconfig-gfarm\fR
but gfmd replication is enabled automatically.
.TP
\fBconfig-gfarm-slave \fImaster-host-id\fB\fR
This sub-command is the same as \fBconfig-gfarm\fR
but gfmd replication is enabled automatically and the remote gfmd host
is configured as a slave of \fImaster-host-id\fR\&.
Then \fBgfservice\fR registers the slave host to a server list
using \fBgfmdhost\fR command.
\fBgfservice\fR also adds the slave host to
metadb_server_list directive in
\fIgfarm2.conf\fR file on the master gfmd host and
distribute the updated \fIgfarm2.conf\fR file to all hosts
defined in the configuration file (gfmd\fIn\fR,
gfsd\fIn\fR and client\fIn\fR).
.TP
\fBunconfig-gfarm\fR
Execute "\fBstop-gfarm\fR" sub-command and then delete all
files and directories created by gfmd and a backend database.
If you want to unconfigure a slave gfmd, use
"\fBunconfig-gfarm-slave\fR" sub-command instead.
.TP
\fBunconfig-gfarm-master\fR
An alias of "\fBunconfig-gfarm\fR" sub-command.
.TP
\fBunconfig-gfarm-slave \fImaster-host-id\fB\fR
This sub-command is the same as "\fBunconfig-gfarm\fR",
but \fBgfservice\fR does some additional works.
It also deletes the slave host from a server list using
\fBgfmdhost\fR command and from
metadb_server_list directive in
\fIgfarm2.conf\fR file on all hosts defined in the
configuration file (gfmd\fIn\fR, 
gfsd\fIn\fR and client\fIn\fR).
.SH "SUB-COMMANDS FOR GFSD"
.PP
The followings are sub-commands which operate \fBgfsd\fR\&.
The given host-id argument must be "gfsd\fIn\fR"
(gfsd1, gfsd2, ...).
Otherwise \fBgfservice\fR reports an error and exits
immediately.
.TP
\fBgfsd-status\fR
Exit with an exit code 0, if \fBgfsd\fR is currently running.
Otherwise exits with 1.
.TP
\fBstart-gfsd\fR
Start \fBgfsd\fR if it is not running currently.
.TP
\fBstop-gfsd\fR
Stop \fBgfsd\fR if it is running currently.
.TP
\fBrestart-gfsd\fR
Perform "\fBstop-gfsd\fR" and "\fBstart-gfsd\fR"
sub-commands successively.
.TP
\fBconfig-gfsd\fR
Execute "\fBconfig-gfsd\fR" command on the remote host.
If "gfsd\fIn\fR_CONFIG_GFSD_OPTIONS" variable is
declared in the configuration file of \fBgfservice\fR,
its value is passed to \fBconfig-gfsd\fR command as
options.
\fBgfservice\fR also registers the configured remote host
as a filesystem node using \fBgfhost\fR command.
.TP
\fBunconfig-gfsd\fR
Execute "\fBstop-gfsd\fR" sub-command and then delete all
files and directories created by gfsd.
.SH "SUB-COMMANDS FOR CLIENT"
.PP
The followings are sub-commands which operate a client.
The given host-id argument must be "gfmd\fIn\fR"
(gfmd1, gfmd2, ...), "gfsd\fIn\fR" (gfsd1, gfsd2, ...)
or "client\fIn\fR" (client1, client2, ...).
Otherwise \fBgfservice\fR reports an error and exits
immediately.
.TP
\fBmount \fIdirectory\fB \fIoption...\fB\fR
Mount a Gfarm2 filesystem on \fIdirectory\fR on the
remote host.
The argument \fIoption\fR is an option to 
\fBgfarm2fs\fR command. If \fBgfarm2fs\fR
command is installed to a directory different from directory which
Gfarm is installed(%%BINDIR%%), you can specify a path
to \fBgfarm2fs\fR command
in \fIgfservice.conf\fR\&. See gfservice.conf(5) for
more details about the configuration file.
.TP
\fBunmount \fIdirectory\fB\fR
Unmount a Gfarm2 filesystem on \fIdirectory\fR on the
remote host.
.TP
\fBumount \fIdirectory\fB\fR
An alias of "\fBunmount\fR" sub-command.
.TP
\fBset-gfarm-conf \fIdirective\fB \fIvalue\fB\fR
Add

.nf
	\fIdirective\fR \fIvalue\fR
.fi

line to \fIgfarm2.conf\fR file on the remote host.
If \fIgfarm2.conf\fR already has a
\fIdirective\fR line, \fBgfservice\fR
deletes it and then add a new line.
.TP
\fBunset-gfarm-conf \fIdirective\fB\fR
Delete a \fIdirective\fR line in
\fIgfarm2.conf\fR file on the remote host.
If \fIgfarm2.conf\fR file doesn't contain
\fIdirective\fR line, the file is unchanged.
.TP
\fBbackup-gfarm-conf\fR
Output \fIgfarm2.conf\fR file on the remote host to
standard out.
.TP
\fBbackup-shared-key\fR
Output a shared secret key file to standard out.
.TP
\fBrestore-gfarm-conf\fR
Recover \fIgfarm2.conf\fR file on the remote host.
\fBgfservice\fR reads a backup of \fIgfarm2.conf\fR
from standard in.
.TP
\fBrestore-shared-key\fR
Recover a shared secret key file on the remote host.
\fBgfservice\fR reads a backup of the shared secret key from
standard in.
.TP
\fBconfig-client\fR
Copy \fIgfarm2.conf\fR file from gfmd1 to the client
host. This sub-command also copies a shared secret key file when
\fB-k\fR option is specified.
.TP
\fBunconfig-client\fR
Delete \fIgfarm2.conf\fR file and a shared secret key file
on the remote host.
.TP
\fBgfcmd \fIcommand-name\fB \fIcommand-argument ...\fB\fR
Execute a Gfarm command on the remote host.
.SH "SUB-COMMANDS WHICH OPERATE ON MULTIPLE HOSTS"
.PP
The followings are sub-commands which operate on multiple hosts.
The host-id argument must not be specified.
.TP
\fBstart-all-servers\fR
For each host configured in configuration file, start a backend database
and \fBgfmd\fR if host-id is "gfmd\fIn\fR",
start \fBgfsd\fR if host-id is "gfsd\fIn\fR".
.TP
\fBstop-all-servers\fR
For each host configured in configuration file, stop a backend database
and \fBgfmd\fR if host-id is "gfmd\fIn\fR",
stop \fBgfsd\fR if host-id is "gfsd\fIn\fR".
.TP
\fBrestart-all-servers\fR
Perform "\fBstop-all-servers\fR" and
"\fBstart-all-servers\fR" sub-commands successively.
.SH "PLUGIN SYSTEM"
.PP
\fBgfservice\fR has a plug-in system so that user can add
new sub-commands. If given sub-command is not provided by
\fBgfservice\fR, \fBgfservice\fR refers to
a file which has name of sub-command under %%DATADIR%%/gfarm/gfservice
directory.
.PP
Sub-command file must be written as Bourne shell script. Sub-command
file for sub-command "\fIname\fR", must have
shell function named
"\fBsubcmd_\fIname\fB\fR" which
will be executed from \fBgfservice\fR, and
"\fBsubcmd_\fIname\fB_agent\fR"
which will be executed from \fBgfservice-agent\fR\&.
.PP
For the case a sub-command depends on a other user provided
sub-command, Sub-command file for sub-command
"\fIname\fR", must have shell function named
"\fB\fIname\fB_depends\fR" which
must return list of sub-commands. List of sub-commands must be a
string which is space separated list of sub-command names. If
sub-command or it's agent does not have dependencies, return empty
string.  Similarly, sub-command file must have shell function named
"\fB\fIname\fB_agent_depends\fR"
which must return list of sub-command's agents.
